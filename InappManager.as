package  {		import com.adobe.ane.productStore.Product;    import com.adobe.ane.productStore.ProductEvent;    import com.adobe.ane.productStore.ProductStore;    import com.adobe.ane.productStore.Transaction;    import com.adobe.ane.productStore.TransactionEvent;	import flash.net.SharedObject;	import flash.net.URLLoader	import flash.net.URLRequest	import flash.events.Event	import flash.events.ErrorEvent; 	import flash.events.IOErrorEvent; 	import flash.events.SecurityErrorEvent;			public class InappManager {				private var mymain:Main		public var productStore:ProductStore		public var inappReadyForBuying:Boolean = false		//private var myproductid:String = "horsecoloring_iapp_0"		private var myproductid:String = "com.wungi.horsecoloring.unlockall.one"		public var buyingmode:String				public function InappManager(inmain,inbuyingmode:String="purchase") {			mymain = inmain			buyingmode = inbuyingmode			if (check_isSupported()) {				mymain.alert("please wait..")				get_Product()			}			else {				mymain.alert("in app purchase not possible")			}					}	  	protected function check_isSupported():Boolean {			productStore=new ProductStore()						productStore.addEventListener(TransactionEvent.PURCHASE_TRANSACTION_SUCCESS, purchaseTransactionSucceeded);			productStore.addEventListener(TransactionEvent.PURCHASE_TRANSACTION_CANCEL, purchaseTransactionCanceled);			productStore.addEventListener(TransactionEvent.PURCHASE_TRANSACTION_FAIL, purchaseTransactionFailed);							productStore.addEventListener(TransactionEvent.RESTORE_TRANSACTION_SUCCESS, restoreTransactionSucceeded);			productStore.addEventListener(TransactionEvent.RESTORE_TRANSACTION_FAIL, restoreTransactionFailed);			productStore.addEventListener(TransactionEvent.RESTORE_TRANSACTION_COMPLETE,  restoreTransactionCompleted);									//ON DEVICE AND ENABLED			mymain.console.log("product store is supported: "+ ProductStore.isSupported); //on device			mymain.console.log("product store is available: "+ productStore.available);  //user has not blocked inapp						//ONLINE CHECK			var req:URLRequest = new URLRequest("http://www.wungi.com/stats.php")			var loader:URLLoader = new URLLoader();			loader.addEventListener(Event.COMPLETE, onUrlLoaded);			loader.addEventListener(IOErrorEvent.IO_ERROR,httpRequestError )			//loader.addEventListener( IOErrorEvent.IOERROR, httpRequestError );     		loader.addEventListener(SecurityErrorEvent.SECURITY_ERROR, httpRequestError ); 			loader.load(req);						//TODO check for online			if (ProductStore.isSupported && productStore.available ) return true			else return false		}				private function onUrlLoaded(e:Event) {			var result:String = e.target.data;			mymain.console.log("wungi stats service: " + result)		}				private function httpRequestError(e:ErrorEvent) {			var result:String = e.type			mymain.console.log("Cannot acces wungi stats service, device might be offline. Error: " + result)			mymain.alert("Please go online to unlock all drawings")		}				public function get_Product():void {			mymain.console.log("in get_Product");			productStore.addEventListener(ProductEvent.PRODUCT_DETAILS_SUCCESS,productDetailsSucceeded);			productStore.addEventListener(ProductEvent.PRODUCT_DETAILS_FAIL, productDetailsFailed);						var vector:Vector.<String> = new Vector.<String>(1);			vector[0] = myproductid;			productStore.requestProductsDetails(vector);			mymain.console.log( "requesting details for: "+ vector);		}				public function productDetailsSucceeded(e:ProductEvent):void {			mymain.console.log("DETAILS SUCCESS "+e);			var i:uint=0;			while(e.products && i < e.products.length)			{				var p:Product = e.products[i];				mymain.console.log("Product details:")				mymain.console.log("- title: "+p.title);				mymain.console.log("- description: "+p.description);				mymain.console.log("- identifier: "+p.identifier);				mymain.console.log("- priceLocale: "+p.priceLocale);				mymain.console.log("- price:"+p.price);				i++;			}						inappReadyForBuying = true			//check if player already bought the product and if so, act on it.			if (buyingmode == "purchase") makePurchase()        	else if (buyingmode == "restore") restore_Transactions()			else mymain.console.log("unknown buying mode: " + buyingmode)		}				public function productDetailsFailed(e:ProductEvent):void {			mymain.console.log("DETAILS FAILED"+e);			var i:uint=0;			while(e.invalidIdentifiers && i < e.invalidIdentifiers.length)			{				mymain.console.log(e.invalidIdentifiers[i]);				i++;			}		}						public function makePurchase() {			if (this.inappReadyForBuying) {				mymain.console.log("in makepurchase")				productStore.makePurchaseTransaction(myproductid,1);			}			else mymain.console.log("in apps not ready for buying")		}				//SUCCESFUL SALE		protected function purchaseTransactionSucceeded(e:TransactionEvent):void {			 mymain.console.log("PURCHASE SUCCES " +e);			 mymain.onUserHasPaid();			 var i:uint=0;			 while(e.transactions && i < e.transactions.length)			 {			   var t = e.transactions[i];			   printTransaction(t);			   i++;			 }			 getPendingTransaction(productStore);			 mymain.alert("Thank you, drawings unlocked!")		}		protected function purchaseTransactionCanceled(e:TransactionEvent):void{			mymain.console.log("CANCELLED "+e);			var i:uint=0;			while(e.transactions && i < e.transactions.length)			{				var t:Transaction = e.transactions[i];				//printTransaction(t);				i++;				productStore.addEventListener(TransactionEvent.FINISH_TRANSACTION_SUCCESS, finishTransactionSucceeded);				productStore.finishTransaction(t.identifier);			}			getPendingTransaction(productStore);		}            		protected function purchaseTransactionFailed(e:TransactionEvent):void		{			mymain.console.log("FAILED "+e);			var i:uint=0;			while(e.transactions && i < e.transactions.length)			{				var t:Transaction = e.transactions[i];				//printTransaction(t);				i++;				productStore.addEventListener(TransactionEvent.FINISH_TRANSACTION_SUCCESS, finishTransactionSucceeded);				productStore.finishTransaction(t.identifier);			}			getPendingTransaction(productStore);		}				//BEGIN RESTORE		//CALLED FROM THUMB		public function restore_Transactions():void {						mymain.console.log("RESTORING TRANSACTION");						productStore.restoreTransactions();			        }				 protected function restoreTransactionSucceeded(e:TransactionEvent):void {			mymain.console.log("RESTORE SUCCEED");			mymain.console.log("RESTORE SUCCEED LONG VERSION " +e);						var i:uint=0;			while(e.transactions && i < e.transactions.length)			{				var t:Transaction = e.transactions[i];				printTransaction(t);				i++;				mymain.console.log("FinishTransactions" + t.identifier);				productStore.addEventListener(TransactionEvent.FINISH_TRANSACTION_SUCCESS, finishTransactionSucceeded);				productStore.finishTransaction(t.identifier);			}						getPendingTransaction(productStore);         }            		protected function restoreTransactionFailed(e:TransactionEvent):void {			mymain.console.log("RESTORE FAILED " +e);					}            		protected function restoreTransactionCompleted(e:TransactionEvent):void{			mymain.console.log("RESTORE COMPLETED " +e);					}						//END RESTORE            		//FINISH MUST ALWAYS BE CALLED		protected function finishTransactionSucceeded(e:TransactionEvent):void{			mymain.console.log("TRANSACTION FINISH " +e);			var i:uint=0;			while(e.transactions && i < e.transactions.length)			{				var t:Transaction = e.transactions[i];				printTransaction(t);				i++;			}		}				public function getPendingTransaction(prdStore:ProductStore):void		{			trace("TRANSACTION PENDING");			var transactions:Vector.<Transaction> = prdStore.pendingTransactions; 			var i:uint=0;			while(transactions && i<transactions.length)			{				var t:Transaction = transactions[i];				//printTransaction(t);				i++;			}		}								public function printTransaction(t:Transaction):void {			mymain.console.log("\n-------------------in Print Transaction----------------------");			mymain.console.log("identifier :"+t.identifier);			mymain.console.log("productIdentifier: "+ t.productIdentifier);			mymain.console.log("productQuantity: "+t.productQuantity);			mymain.console.log("date: "+t.date);			mymain.console.log("receipt: "+t.receipt);			mymain.console.log("error: "+t.error);			mymain.console.log("originalTransaction: "+t.originalTransaction);			if(t.originalTransaction)				printTransaction(t.originalTransaction);			mymain.console.log("---------end of print transaction----------------------------\n");        			}        			}	}